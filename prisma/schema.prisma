// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // Include binaries for both Alpine (musl, OpenSSL 3) and glibc (OpenSSL 3)
  // so the generated client works on Railway regardless of base image.
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  settings  Json     @default("{}")

  emailAccounts EmailAccount[]
  todos         Todo[]

  @@map("users")
}

model EmailAccount {
  id              String    @id @default(cuid())
  userId          String
  provider        String    // 'gmail' or 'yahoo'
  email           String
  accessToken     String?   // Encrypted
  refreshToken    String?   // Encrypted
  tokenExpiresAt  DateTime?
  syncState       Json      @default("{}")
  lastSyncAt      DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  emails Email[]

  @@unique([userId, provider, email])
  @@map("email_accounts")
}

model Email {
  id            String   @id @default(cuid())
  accountId     String
  messageId     String   // Provider-specific message ID
  threadId      String?
  subject       String?
  sender        String
  recipients    String[]
  body          String?
  snippet       String?
  category      String?
  subcategories String[]
  isNewsletter  Boolean  @default(false)
  hasTodos      Boolean  @default(false)
  priority      Int      @default(3) // 1-5 scale
  isRead        Boolean  @default(false)
  receivedAt    DateTime
  processedAt   DateTime @default(now())
  metadata      Json     @default("{}")

  account EmailAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  todos   Todo[]

  @@unique([accountId, messageId])
  @@index([accountId, receivedAt])
  @@index([category, priority])
  @@map("emails")
}

model Todo {
  id          String    @id @default(cuid())
  emailId     String
  userId      String
  title       String
  description String?
  dueDate     DateTime?
  priority    String    @default("medium") // urgent, high, medium, low
  status      String    @default("pending") // pending, completed, snoozed
  confidence  Float?
  context     Json      @default("{}")
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([dueDate])
  @@map("todos")
}

model UnsubscribeTracking {
  id                String    @id @default(cuid())
  userId            String
  senderDomain      String
  senderEmail       String
  unsubscribeMethod String    // 'link', 'email', 'list-unsubscribe'
  unsubscribeUrl    String?
  status            String    // 'pending', 'attempted', 'success', 'failed'
  attemptedAt       DateTime?
  succeededAt       DateTime?
  errorMessage      String?
  createdAt         DateTime  @default(now())

  @@unique([userId, senderDomain, senderEmail])
  @@index([userId, status])
  @@map("unsubscribe_tracking")
}

model SyncHistory {
  id             String   @id @default(cuid())
  accountId      String
  syncType       String   // 'initial', 'incremental', 'manual'
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  emailsFetched  Int      @default(0)
  emailsProcessed Int     @default(0)
  todosExtracted Int      @default(0)
  status         String   // 'running', 'completed', 'failed'
  errorMessage   String?
  metadata       Json     @default("{}")

  @@index([accountId, startedAt])
  @@map("sync_history")
}
